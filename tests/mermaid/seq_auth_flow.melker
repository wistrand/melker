<melker>
<policy>
{
  "name": "Sequence: tests/mermaid/seq_auth_flow.mmd"
}
</policy>

<style>
.sequence-container {
  width: fill;
  height: auto;
  padding: 1;
}
.sequence-table {
  width: fill;
}
.participant {
  text-align: center;
}
.actor {
  text-align: center;
}
.lifeline {
  text-align: center;
}
.lifeline-bar {
  border-left: thin;
  height: 2;
}
.note {
  text-align: center;
}
.note-bar {
  border-left: thin;
  height: 2;
}
</style>

<container style="padding: 1; flex-direction: column; overflow: scroll; height: auto">
  <table class="sequence-table" border="none" columnBorders="false" cellPadding="1">
    <thead>
      <tr>
        <th id="seq-U" class="participant">User</th>
        <th id="seq-A" class="participant">App</th>
        <th id="seq-I" class="participant">Identity Provider</th>
        <th id="seq-R" class="participant">Resource Server</th>
      </tr>
    </thead>
    <tbody>
      <!-- U -> A: Click Login -->
      <tr>
        <td class="lifeline"><container id="seq-msg-0-U" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-0-A" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- A -> I: Redirect to /authorize -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-1-A" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-1-I" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- I -> U: Show login form -->
      <tr>
        <td class="lifeline"><container id="seq-msg-2-U" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-2-I" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- U -> I: Enter credentials -->
      <tr>
        <td class="lifeline"><container id="seq-msg-3-U" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-3-I" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- I -> I: Validate credentials -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-4-I" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- Note: Generate auth code -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="note"><container class="note-bar"><text style="text-wrap: wrap">Generate auth code</text></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- I -> A: Redirect with code -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-5-A" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-5-I" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- A -> I: POST /token with code -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-6-A" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-6-I" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- I -> A: Access + Refresh tokens -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-7-A" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-7-I" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- Note: Store tokens securely -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="note"><container class="note-bar"><text style="text-wrap: wrap">Store tokens securely</text></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- A -> R: GET /api/data + Bearer token -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-8-A" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-8-R" class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- R -> R: Validate token -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-9-R" class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- R -> A: Protected data -->
      <tr>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-10-A" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-10-R" class="lifeline-bar"><text text="" /></container></td>
      </tr>
      <!-- A -> U: Display data -->
      <tr>
        <td class="lifeline"><container id="seq-msg-11-U" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container id="seq-msg-11-A" class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
        <td class="lifeline"><container class="lifeline-bar"><text text="" /></container></td>
      </tr>
    </tbody>
    <tfoot>
      <tr>
        <td id="seq-bottom-U" class="participant">User</td>
        <td id="seq-bottom-A" class="participant">App</td>
        <td id="seq-bottom-I" class="participant">Identity Provider</td>
        <td id="seq-bottom-R" class="participant">Resource Server</td>
      </tr>
    </tfoot>
  </table>

  <!-- Message connectors -->
  <connector from="seq-msg-0-U" to="seq-msg-0-A" routing="horizontal" arrow="end" label="Click Login" />
  <connector from="seq-msg-1-A" to="seq-msg-1-I" routing="horizontal" arrow="end" label="Redirect to /authorize" />
  <connector from="seq-msg-2-I" to="seq-msg-2-U" routing="horizontal" arrow="end" label="Show login form" />
  <connector from="seq-msg-3-U" to="seq-msg-3-I" routing="horizontal" arrow="end" label="Enter credentials" />
  <connector from="seq-msg-5-I" to="seq-msg-5-A" routing="horizontal" arrow="end" label="Redirect with code" style="line-style: dashed" />
  <connector from="seq-msg-6-A" to="seq-msg-6-I" routing="horizontal" arrow="end" label="POST /token with code" />
  <connector from="seq-msg-7-I" to="seq-msg-7-A" routing="horizontal" arrow="end" label="Access + Refresh tokens" style="line-style: dashed" />
  <connector from="seq-msg-8-A" to="seq-msg-8-R" routing="horizontal" arrow="end" label="GET /api/data + Bearer token" />
  <connector from="seq-msg-10-R" to="seq-msg-10-A" routing="horizontal" arrow="end" label="Protected data" style="line-style: dashed" />
  <connector from="seq-msg-11-A" to="seq-msg-11-U" routing="horizontal" arrow="end" label="Display data" style="line-style: dashed" />
</container>
</melker>